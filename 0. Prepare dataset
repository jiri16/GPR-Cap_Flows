use "xxx\working_data.dta"


** get stata dates (18852)

gen ym = monthly(date, "YM")
format ym %tm


** create controls variables
encode iso3, generate(ifs)
xtset ifs ym

bysort ifs (ym): gen gr_us_indprod = (indprod_us - indprod_us[_n-1]) / indprod_us[_n-1]
bysort ifs (ym): gen gr_indprod = (indprod - indprod[_n-1]) / indprod[_n-1]
bysort ifs (ym): gen gr_er = (er - er[_n-1]) / er[_n-1]
bysort ifs (ym): gen gr_msci = (msci - msci[_n-1]) / msci[_n-1]


** create EM
gen em=1
replace em=0 if iso3=="AUS" | iso3=="BEL" | iso3=="CAN" |  iso3=="CHE" | iso3=="DEU" | iso3=="DNK" | iso3=="ESP" | iso3=="FIN" | iso3=="FRA" | iso3=="GBR" | iso3=="ITA" | iso3=="JPN" | iso3=="NLD" | iso3=="NOR" | iso3=="PRT" | iso3=="SWE"

** creat EM dummy
gen gprc_em = gprc*em



** create normalized and winsorized flows

** bonds

xtset ifs ym

bysort ifs (ym): gen n_bond_hol = bt_us_net_pur_bond/bt_hol_bond[_n-1]
winsor n_bond_hol, gen(w_n_bond_hol) p(0.01)
replace w_n_bond_hol = w_n_bond_hol*100

** equity
bysort ifs (ym): gen n_stock_hol = bt_us_net_pur_stock/bt_hol_stock[_n-1]
winsor n_stock_hol, gen(w_n_stock_hol) p(0.01)
replace w_n_stock_hol = w_n_stock_hol*100



** dropping 0.5%


* Generate quantile variables for 0.5% and 99.5% for n_stock_hol
xtile p_stock_hol = n_stock_hol, nq(200)

* Replace top and bottom 0.5% of n_stock_hol with missing
replace n_stock_hol = . if p_stock_hol <= 1
replace n_stock_hol = . if p_stock_hol >= 200

* Generate quantile variables for 0.5% and 99.5% for n_bond_hol
xtile p_bond_hol = n_bond_hol, nq(200)

* Replace top and bottom 0.5% of n_bond_hol with missing
replace n_bond_hol = . if p_bond_hol <= 1
replace n_bond_hol = . if p_bond_hol >= 200

* Rename the variables
rename n_stock_hol w_n_stock_hol
rename n_bond_hol w_n_bond_hol

* Multiply each by a factor of 100
replace w_n_stock_hol = w_n_stock_hol * 100
replace w_n_bond_hol = w_n_bond_hol * 100

* Drop the temporary quantile variables
drop p_stock_hol p_bond_hol



